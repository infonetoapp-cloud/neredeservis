rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() { return request.auth != null; }
    function isSelf(uid) { return signedIn() && request.auth.uid == uid; }

    function userRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isRouteMemberFromDoc(data) {
      return signedIn() && request.auth.uid in data.memberIds;
    }

    match /users/{uid} {
      allow read: if isSelf(uid);
      allow write: if false;
      allow delete: if false;
    }

    match /driver_directory/{driverId} {
      allow read: if false;
      allow write: if false;
    }

    match /drivers/{driverId} {
      allow read: if isSelf(driverId);
      allow write: if false;
      allow delete: if false;
    }

    match /routes/{routeId} {
      allow read: if isRouteMemberFromDoc(resource.data);
      allow write: if false;
    }

    match /routes/{routeId}/stops/{stopId} {
      allow read: if signedIn() &&
        request.auth.uid in get(/databases/$(database)/documents/routes/$(routeId)).data.memberIds;
      allow write: if false;
    }

    match /routes/{routeId}/passengers/{passengerId} {
      allow read: if isSelf(passengerId) || (
        signedIn() &&
        request.auth.uid in get(/databases/$(database)/documents/routes/$(routeId)).data.authorizedDriverIds
      ) || (
        signedIn() &&
        get(/databases/$(database)/documents/routes/$(routeId)).data.driverId == request.auth.uid
      );
      allow write: if false;
    }

    match /routes/{routeId}/skip_requests/{skipRequestId} {
      allow read: if (
        signedIn() && request.auth.uid == resource.data.passengerId
      ) || (
        signedIn() &&
        request.auth.uid in get(/databases/$(database)/documents/routes/$(routeId)).data.authorizedDriverIds
      ) || (
        signedIn() &&
        get(/databases/$(database)/documents/routes/$(routeId)).data.driverId == request.auth.uid
      );
      allow write: if false;
    }

    match /trips/{tripId} {
      allow read: if signedIn() &&
        request.auth.uid in get(/databases/$(database)/documents/routes/$(resource.data.routeId)).data.memberIds;
      allow write: if false;
    }

    match /announcements/{announcementId} {
      allow read: if signedIn() &&
        request.auth.uid in get(/databases/$(database)/documents/routes/$(resource.data.routeId)).data.memberIds;
      allow write: if false;
    }

    match /guest_sessions/{sessionId} {
      allow read: if signedIn() && request.auth.uid == resource.data.guestUid;
      allow write: if false;
    }

    match /consents/{uid} {
      allow read: if isSelf(uid);
      allow write: if false;
      allow delete: if false;
    }

    match /trip_requests/{id} {
      allow read: if false;
      allow write: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
